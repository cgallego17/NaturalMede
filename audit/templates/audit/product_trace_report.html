{% extends 'audit/base.html' %}
{% load static %}

{% block page_title_text %}Reporte de Trazabilidad{% endblock %}
{% block page_title_display %}Reporte de Trazabilidad{% endblock %}

{% block page_actions %}
    <a href="{% url 'audit:inventory_trace_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
    <button onclick="window.print()" class="btn btn-info">
        <i class="fas fa-print"></i> Imprimir
    </button>
    <a href="{% url 'audit:inventory_trace_export' %}?product={{ product.id }}" class="btn btn-success">
        <i class="fas fa-download"></i> Exportar
    </a>
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'audit:dashboard' %}">Auditoría</a></li>
    <li class="breadcrumb-item"><a href="{% url 'audit:inventory_trace_dashboard' %}">Trazabilidad</a></li>
    <li class="breadcrumb-item"><a href="{% url 'audit:inventory_trace_list' %}">Lista</a></li>
    <li class="breadcrumb-item active">Reporte</li>
{% endblock %}

{% block extra_css %}
<style>
.report-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
}

.product-info {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.summary-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 5px solid;
}

.summary-card.incoming {
    border-left-color: #48dbfb;
}

.summary-card.outgoing {
    border-left-color: #ff6b6b;
}

.summary-card.net {
    border-left-color: #26de81;
}

.summary-card.current {
    border-left-color: #feca57;
}

.summary-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.summary-label {
    color: #666;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.timeline {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.timeline-item {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #eee;
    position: relative;
}

.timeline-item:last-child {
    border-bottom: none;
}

.timeline-item:before {
    content: '';
    position: absolute;
    left: 30px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #ddd;
}

.timeline-item:last-child:before {
    display: none;
}

.timeline-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 20px;
    position: relative;
    z-index: 1;
    font-size: 1.5rem;
    color: white;
}

.timeline-icon.incoming {
    background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
}

.timeline-icon.outgoing {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
}

.timeline-icon.adjustment {
    background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
}

.timeline-icon.transfer {
    background: linear-gradient(135deg, #a55eea 0%, #26de81 100%);
}

.timeline-content {
    flex: 1;
}

.timeline-title {
    font-weight: bold;
    margin-bottom: 5px;
}

.timeline-meta {
    color: #666;
    font-size: 0.9rem;
}

.timeline-quantity {
    font-size: 1.2rem;
    font-weight: bold;
    margin-left: 15px;
}

.timeline-quantity.positive {
    color: #28a745;
}

.timeline-quantity.negative {
    color: #dc3545;
}

.warehouse-breakdown {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.warehouse-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #eee;
}

.warehouse-item:last-child {
    border-bottom: none;
}

.warehouse-name {
    font-weight: bold;
}

.warehouse-stock {
    font-size: 1.2rem;
    font-weight: bold;
    color: #007bff;
}

.chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

@media print {
    .page-actions {
        display: none !important;
    }
    
    .report-header {
        background: #667eea !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
    
    .summary-card, .product-info, .timeline, .warehouse-breakdown, .chart-container {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
    }
}
</style>
{% endblock %}

{% block page_content %}
    <!-- Header del Reporte -->
    <div class="report-header">
        <div class="row">
            <div class="col-md-8">
                <h2 class="mb-2">
                    <i class="fas fa-chart-line"></i>
                    Reporte de Trazabilidad
                </h2>
                <h4 class="mb-0">{{ product.name }}</h4>
                <p class="mb-0">
                    <code>{{ product.sku }}</code> | 
                    Generado el {{ "now"|date:"d/m/Y H:i:s" }}
                </p>
            </div>
            <div class="col-md-4 text-right">
                {% if product.images.first %}
                    <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" 
                         class="img-fluid" style="max-height: 100px; border-radius: 10px;">
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Información del Producto -->
    <div class="product-info">
        <div class="row">
            <div class="col-md-6">
                <h5 class="mb-3">
                    <i class="fas fa-box text-primary"></i>
                    Información del Producto
                </h5>
                <div class="row">
                    <div class="col-6">
                        <strong>SKU:</strong><br>
                        <code>{{ product.sku }}</code>
                    </div>
                    <div class="col-6">
                        <strong>Categoría:</strong><br>
                        {% if product.category %}
                            {{ product.category.name }}
                        {% else %}
                            Sin categoría
                        {% endif %}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <strong>Marca:</strong><br>
                        {% if product.brand %}
                            {{ product.brand.name }}
                        {% else %}
                            Sin marca
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <strong>Precio:</strong><br>
                        ${{ product.price|floatformat:2 }}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="mb-3">
                    <i class="fas fa-info-circle text-info"></i>
                    Resumen de Movimientos
                </h5>
                <div class="row">
                    <div class="col-6">
                        <strong>Total Entradas:</strong><br>
                        <span class="text-success">{{ total_incoming|floatformat:0 }} unidades</span>
                    </div>
                    <div class="col-6">
                        <strong>Total Salidas:</strong><br>
                        <span class="text-danger">{{ total_outgoing|floatformat:0 }} unidades</span>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <strong>Movimiento Neto:</strong><br>
                        <span class="{% if net_movement >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if net_movement >= 0 %}+{% endif %}{{ net_movement|floatformat:0 }} unidades
                        </span>
                    </div>
                    <div class="col-6">
                        <strong>Stock Actual:</strong><br>
                        <span class="text-primary">{{ current_stock|floatformat:0 }} unidades</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Resumen -->
    <div class="summary-cards">
        <div class="summary-card incoming">
            <div class="summary-value text-success">{{ total_incoming|floatformat:0 }}</div>
            <div class="summary-label">Entradas</div>
        </div>
        <div class="summary-card outgoing">
            <div class="summary-value text-danger">{{ total_outgoing|floatformat:0 }}</div>
            <div class="summary-label">Salidas</div>
        </div>
        <div class="summary-card net">
            <div class="summary-value {% if net_movement >= 0 %}text-success{% else %}text-danger{% endif %}">
                {% if net_movement >= 0 %}+{% endif %}{{ net_movement|floatformat:0 }}
            </div>
            <div class="summary-label">Movimiento Neto</div>
        </div>
        <div class="summary-card current">
            <div class="summary-value text-primary">{{ current_stock|floatformat:0 }}</div>
            <div class="summary-label">Stock Actual</div>
        </div>
    </div>

    <!-- Timeline de Movimientos -->
    <div class="timeline">
        <h5 class="mb-4">
            <i class="fas fa-history text-warning"></i>
            Historial Completo de Movimientos
        </h5>
        
        {% for trace in traces %}
            <div class="timeline-item">
                <div class="timeline-icon {% if trace.is_incoming %}incoming{% elif trace.is_outgoing %}outgoing{% elif trace.movement_type == 'STOCK_ADJUSTMENT' %}adjustment{% elif 'TRANSFER' in trace.movement_type %}transfer{% endif %}">
                    {% if trace.is_incoming %}
                        <i class="fas fa-arrow-down"></i>
                    {% elif trace.is_outgoing %}
                        <i class="fas fa-arrow-up"></i>
                    {% elif trace.movement_type == 'STOCK_ADJUSTMENT' %}
                        <i class="fas fa-adjust"></i>
                    {% elif 'TRANSFER' in trace.movement_type %}
                        <i class="fas fa-exchange-alt"></i>
                    {% endif %}
                </div>
                <div class="timeline-content">
                    <div class="timeline-title">{{ trace.get_movement_type_display }}</div>
                    <div class="timeline-meta">
                        {{ trace.created_at|date:"d/m/Y H:i:s" }} | 
                        {{ trace.warehouse.name }} | 
                        {% if trace.user %}{{ trace.user.username }}{% else %}Sistema{% endif %}
                        {% if trace.supplier %} | {{ trace.supplier.name }}{% endif %}
                    </div>
                </div>
                <div class="timeline-quantity {% if trace.is_incoming %}positive{% else %}negative{% endif %}">
                    {% if trace.is_incoming %}+{% else %}-{% endif %}{{ trace.quantity|floatformat:0 }}
                </div>
            </div>
        {% empty %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>No hay movimientos registrados para este producto.</p>
            </div>
        {% endfor %}
    </div>

    <!-- Desglose por Bodega -->
    {% if warehouse_breakdown %}
    <div class="warehouse-breakdown">
        <h5 class="mb-4">
            <i class="fas fa-warehouse text-info"></i>
            Stock por Bodega
        </h5>
        
        {% for warehouse, stock in warehouse_breakdown.items %}
            <div class="warehouse-item">
                <div class="warehouse-name">{{ warehouse }}</div>
                <div class="warehouse-stock">{{ stock|floatformat:0 }} unidades</div>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Gráfico de Movimientos -->
    {% if traces %}
    <div class="chart-container">
        <h5 class="mb-4">
            <i class="fas fa-chart-area text-success"></i>
            Gráfico de Movimientos por Día
        </h5>
        <canvas id="movementChart" width="400" height="200"></canvas>
    </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
{% if traces %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('movementChart').getContext('2d');
    
    // Preparar datos para el gráfico
    const dailyData = {};
    {% for trace in traces %}
        const date = '{{ trace.created_at|date:"Y-m-d" }}';
        if (!dailyData[date]) {
            dailyData[date] = { incoming: 0, outgoing: 0 };
        }
        {% if trace.is_incoming %}
            dailyData[date].incoming += {{ trace.quantity }};
        {% else %}
            dailyData[date].outgoing += {{ trace.quantity }};
        {% endif %}
    {% endfor %}
    
    const dates = Object.keys(dailyData).sort();
    const incomingData = dates.map(date => dailyData[date].incoming);
    const outgoingData = dates.map(date => dailyData[date].outgoing);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Entradas',
                data: incomingData,
                borderColor: '#48dbfb',
                backgroundColor: 'rgba(72, 219, 251, 0.1)',
                tension: 0.1
            }, {
                label: 'Salidas',
                data: outgoingData,
                borderColor: '#ff6b6b',
                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cantidad'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Fecha'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Movimientos Diarios del Producto'
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}
