{% extends 'custom_admin/base.html' %}

{% block title %}Punto de Venta - NaturalMede Admin{% endblock %}

{% block page_title %}
    <div class="d-flex justify-content-between align-items-center">
        <span>Punto de Venta</span>
        <div class="btn-group">
            <button class="btn btn-outline-success btn-sm" onclick="quickSale()">
                <i class="fas fa-bolt"></i> Venta R谩pida
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="loadProducts()">
                <i class="fas fa-sync"></i> Actualizar
            </button>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Panel de Productos -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="m-0 font-weight-bold text-primary">Productos Disponibles</h6>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="productSearch" 
                                   placeholder="Buscar productos..." onkeyup="searchProducts()">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchProducts()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-2">
                <!-- Filtros r谩pidos -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary active" onclick="filterProducts('all')" id="filterAll">
                                Todos
                            </button>
                            <button class="btn btn-outline-success" onclick="filterProducts('active')" id="filterActive">
                                Activos
                            </button>
                            <button class="btn btn-outline-warning" onclick="filterProducts('featured')" id="filterFeatured">
                                Destacados
                            </button>
                            <button class="btn btn-outline-info" onclick="openBarcodeScanner()">
                                <i class="fas fa-barcode"></i> Escanear
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de productos -->
                <div class="row" id="productsList">
                    <!-- Los productos se cargar谩n aqu铆 din谩micamente -->
                    <div class="col-12 text-center text-muted py-4">
                        <i class="fas fa-box fa-3x mb-3"></i>
                        <div>Cargando productos...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de Venta -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Venta Actual</h6>
                    <span class="badge badge-info" id="itemCount">0 items</span>
                </div>
            </div>
            <div class="card-body p-2">
                <!-- Informaci贸n de la sesi贸n -->
                <div class="alert alert-light py-2 mb-3">
                    <small class="text-muted">
                        <i class="fas fa-user"></i> {{ request.user.get_full_name|default:request.user.username }} | 
                        <i class="fas fa-clock"></i> {{ active_session.opened_at|time:"H:i" }}
                    </small>
                </div>
                
                <!-- Selector de tipo de orden -->
                <div class="mb-3">
                    <label class="form-label small font-weight-bold text-muted">
                        <i class="fas fa-tags"></i> Tipo de Orden
                    </label>
                    <div class="btn-group btn-group-sm w-100" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="btnPrincipal" onclick="setOrderType('principal')">
                            <i class="fas fa-building"></i> Principal
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnAuxiliar" onclick="setOrderType('auxiliar')">
                            <i class="fas fa-clipboard"></i> Auxiliar
                        </button>
                    </div>
                    <small class="form-text text-muted">
                        <span id="orderTypeInfo">Las 贸rdenes principales incluyen IVA del 19%</span>
                    </small>
                </div>
                
                <!-- Carrito de venta -->
                <div id="saleItems" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                        <div>Agrega productos para comenzar</div>
                    </div>
                </div>
                
                <!-- Totales -->
                <div class="border-top pt-3 mt-3">
                    <div class="row mb-1">
                        <div class="col-6">
                            <small>Subtotal:</small>
                        </div>
                        <div class="col-6 text-right">
                            <small id="subtotal">$0</small>
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-6">
                            <small id="taxLabel">IVA (19%):</small>
                        </div>
                        <div class="col-6 text-right">
                            <small id="tax">$0</small>
                        </div>
                    </div>
                    <div class="row border-top pt-2">
                        <div class="col-6">
                            <strong>Total:</strong>
                        </div>
                        <div class="col-6 text-right">
                            <strong id="total" class="text-primary">$0</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de acci贸n -->
                <div class="mt-3">
                    <button class="btn btn-success btn-block mb-2" onclick="processSale()" disabled id="processSaleBtn">
                        <i class="fas fa-credit-card"></i> 
                        <span id="processSaleText">Procesar Venta Principal</span>
                    </button>
                    <div class="row">
                        <div class="col-6">
                            <button class="btn btn-warning btn-sm btn-block" onclick="clearSale()">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-info btn-sm btn-block" onclick="quickSale()">
                                <i class="fas fa-bolt"></i> R谩pida
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Estad铆sticas de la sesi贸n -->
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Resumen de Sesi贸n</h6>
            </div>
            <div class="card-body p-2">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="fw-bold text-primary h5">{{ session_stats.total_sales }}</div>
                        <div class="small text-muted">Ventas</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold text-success h5" id="sessionTotal">${{ session_stats.total_amount|floatformat:0 }}</div>
                        <div class="small text-muted">Total</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold text-info h5">{{ session_stats.total_items }}</div>
                        <div class="small text-muted">Items</div>
                    </div>
                </div>
                <div class="mt-2">
                    <button class="btn btn-outline-success btn-sm btn-block" onclick="openCashModal()" id="openCashButton" style="display: none;">
                        <i class="fas fa-unlock"></i> Abrir Caja
                    </button>
                    <button class="btn btn-outline-warning btn-sm btn-block" onclick="closeCashModal()" id="closeCashButton" style="display: none;">
                        <i class="fas fa-lock"></i> Cerrar Caja
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historial de ventas de la sesi贸n actual -->
<div class="card mt-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="m-0 font-weight-bold text-primary">Ventas de la Sesi贸n</h6>
                <small class="text-muted">
                    <i class="fas fa-building"></i> {{ active_session.warehouse.name }} | 
                    <i class="fas fa-clock"></i> {{ active_session.opened_at|time:"H:i" }} | 
                    <i class="fas fa-receipt"></i> {{ session_stats.total_sales }} ventas
                </small>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshSales()">
                <i class="fas fa-sync"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0" id="salesTable">
                <thead class="thead-light">
                    <tr>
                        <th>#</th>
                        <th>Hora</th>
                        <th>Cliente</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>M茅todo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td><strong>#{{ sale.id }}</strong></td>
                        <td>{{ sale.created_at|time:"H:i" }}</td>
                        <td>
                            {% if sale.customer %}
                            {{ sale.customer.user.get_full_name|default:sale.customer.user.username }}
                            {% else %}
                            <span class="text-muted">General</span>
                            {% endif %}
                        </td>
                        <td><span class="badge badge-info">{{ sale.items.count }}</span></td>
                        <td><strong>${{ sale.total|floatformat:0 }}</strong></td>
                        <td>
                            <span class="badge badge-{% if sale.payment_method == 'cash' %}success{% elif sale.payment_method == 'card' %}primary{% else %}info{% endif %}">
                                {{ sale.get_payment_method_display }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewSale({{ sale.id }})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="printReceipt({{ sale.id }})" title="Imprimir">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-receipt fa-2x mb-2"></i>
                            <div>No hay ventas en esta sesi贸n</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para escanear c贸digo de barras -->
<div class="modal fade" id="barcodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Escanear C贸digo de Barras</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div id="barcodeScanner" style="width: 100%; height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                        <div class="text-muted">
                            <i class="fas fa-barcode fa-3x mb-2"></i>
                            <div>Funcionalidad de esc谩ner en desarrollo</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <input type="text" class="form-control" id="manualBarcode" placeholder="Ingresar c贸digo manualmente">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="searchByBarcode()">Buscar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para procesar venta -->
<div class="modal fade" id="processSaleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-cash-register"></i> Procesar Venta
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div class="row no-gutters">
                    <!-- Panel izquierdo: Informaci贸n de la venta -->
                    <div class="col-md-8">
                        <div class="p-4">
                            <!-- Resumen de la venta mejorado -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-light border-0">
                                    <h6 class="mb-0 text-primary">
                                        <i class="fas fa-shopping-cart"></i> Resumen de la Venta
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted">Subtotal:</span>
                                                <span class="font-weight-bold" id="modalSubtotal">$0</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted" id="modalTaxLabel">IVA (19%):</span>
                                                <span class="font-weight-bold" id="modalTax">$0</span>
                                            </div>
                                            <hr class="my-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="h6 mb-0">Total:</span>
                                                <span class="h5 text-primary font-weight-bold" id="modalTotal">$0</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted">Items:</span>
                                                <span class="badge badge-info" id="modalItems">0</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted">Monto Recibido:</span>
                                                <span class="font-weight-bold text-success" id="modalReceived">$0</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-muted">Cambio:</span>
                                                <span class="font-weight-bold text-success" id="modalChange">$0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Formulario mejorado -->
                <form id="processSaleForm">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6">
                    <div class="form-group">
                                            <label for="customerSelect" class="font-weight-bold">
                                                <i class="fas fa-user text-primary"></i> Cliente
                                            </label>
                                            <div class="input-group">
                                                <select class="form-control select2" id="customerSelect" name="customer">
                            <option value="">Cliente general</option>
                        </select>
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-outline-primary" onclick="openCreateCustomerModal()" title="Nuevo Cliente">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                    </div>
                                            </div>
                                            <small class="form-text text-muted">Selecciona un cliente o deja en "Cliente general"</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                    <div class="form-group">
                                            <label for="paymentMethod" class="font-weight-bold">
                                                <i class="fas fa-credit-card text-primary"></i> M茅todo de Pago
                                            </label>
                        <select class="form-control" id="paymentMethod" name="payment_method" required>
                                                <option value="cash"> Efectivo</option>
                                                <option value="card"> Tarjeta</option>
                                                <option value="transfer"> Transferencia</option>
                                                <option value="nequi"> Nequi</option>
                                                <option value="daviplata"> Daviplata</option>
                        </select>
                    </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                    <div class="form-group">
                                            <label for="amountReceived" class="font-weight-bold">
                                                <i class="fas fa-money-bill-wave text-primary"></i> Monto Recibido
                                            </label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">$</span>
                    </div>
                                                <input type="text" class="form-control" id="amountReceived" name="amount_received" placeholder="0" oninput="formatAmountInput(this)" onblur="validateAmountInput(this)">
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-outline-secondary" onclick="setExactAmount()" title="Establecer monto exacto">
                                                        <i class="fas fa-equals"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <small class="form-text text-muted">Dejar en 0 para pagos con tarjeta</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                    <div class="form-group">
                                            <label for="discountAmount" class="font-weight-bold">
                                                <i class="fas fa-percentage text-primary"></i> Descuento
                                            </label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">$</span>
                                                </div>
                                                <input type="text" class="form-control" id="discountAmount" name="discount" placeholder="0" oninput="formatAmountInput(this)" onblur="validateAmountInput(this)">
                                            </div>
                                            <small class="form-text text-muted">Descuento aplicado a la venta</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="saleNotes" class="font-weight-bold">
                                        <i class="fas fa-sticky-note text-primary"></i> Notas
                                    </label>
                                    <textarea class="form-control" id="saleNotes" name="notes" rows="3" placeholder="Observaciones sobre la venta..."></textarea>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Panel derecho: Acciones r谩pidas -->
                    <div class="col-md-4 bg-light">
                        <div class="p-4">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-bolt"></i> Acciones R谩pidas
                            </h6>
                            
                            <!-- Botones de montos comunes -->
                            <div class="mb-4">
                                <label class="font-weight-bold text-muted mb-2">Monto Exacto</label>
                                <div class="btn-group-vertical w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-1" onclick="setAmountReceived(50000)">
                                        $50,000
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-1" onclick="setAmountReceived(100000)">
                                        $100,000
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-1" onclick="setAmountReceived(200000)">
                                        $200,000
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-1" onclick="setAmountReceived(500000)">
                                        $500,000
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Informaci贸n del tipo de orden -->
                            <div class="mb-4">
                                <div class="alert alert-info">
                                    <small>
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Tipo de Orden:</strong><br>
                                        <span id="modalOrderTypeInfo">Principal (Con IVA)</span>
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Bot贸n de prueba de inventario -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-warning btn-sm btn-block" onclick="testInventoryDeduction()" title="Probar descuento de inventario">
                                    <i class="fas fa-flask"></i> Probar Inventario
                                </button>
                                <small class="text-muted">Prueba que el inventario se descuente correctamente</small>
                            </div>
                            
                            <!-- Bot贸n de confirmaci贸n -->
                            <div class="text-center">
                                <button type="button" class="btn btn-success btn-lg btn-block" onclick="confirmSale()" id="confirmSaleBtn">
                                    <i class="fas fa-check"></i> Confirmar Venta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <div class="ml-auto">
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> 
                        <span id="modalTimestamp"></span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Modal para abrir caja -->
    <div class="modal fade" id="openCashModal" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-gradient-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-cash-register"></i> Abrir Caja
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="openCashForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="warehouseSelect" class="font-weight-bold">
                                        <i class="fas fa-warehouse text-success"></i> Bodega *
                                    </label>
                                    <select class="form-control" id="warehouseSelect" name="warehouse_id" required>
                                        <option value="">Seleccionar bodega...</option>
                                    </select>
                                    <small class="form-text text-muted">Selecciona la bodega donde trabajar谩s</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="openingCash" class="font-weight-bold">
                                        <i class="fas fa-money-bill-wave text-success"></i> Efectivo Inicial *
                                    </label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <input type="number" class="form-control" id="openingCash" name="opening_cash" step="100" min="0" required placeholder="0">
                                    </div>
                                    <small class="form-text text-muted">Monto con el que inicias la caja</small>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="sessionNotes" class="font-weight-bold">
                                        <i class="fas fa-sticky-note text-info"></i> Notas (Opcional)
                                    </label>
                                    <textarea class="form-control" id="sessionNotes" name="notes" rows="3" placeholder="Observaciones sobre esta sesi贸n..."></textarea>
                                    <small class="form-text text-muted">Informaci贸n adicional sobre la sesi贸n</small>
                                </div>
                                
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title text-success">
                                            <i class="fas fa-info-circle"></i> Informaci贸n Importante
                                        </h6>
                                        <ul class="mb-0 small">
                                            <li>Una vez abierta la caja, podr谩s realizar ventas</li>
                                            <li>Recuerda cerrar la caja al final del d铆a</li>
                                            <li>El sistema generar谩 un reporte detallado</li>
                                            <li>Verifica el efectivo inicial antes de abrir</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="openCashRegister()" id="openCashBtn">
                        <i class="fas fa-unlock"></i> Abrir Caja
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cerrar caja -->
    <div class="modal fade" id="closeCashModal" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-gradient-warning text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-lock"></i> Cerrar Caja
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body p-0">
                    <div class="row no-gutters">
                        <!-- Panel izquierdo: Resumen de caja -->
                        <div class="col-md-6">
                            <div class="p-4">
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-light border-0">
                                        <h6 class="mb-0 text-warning">
                                            <i class="fas fa-calculator"></i> Resumen de Caja
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted">Efectivo Inicial:</span>
                                                    <span class="font-weight-bold" id="closeOpeningCash">$0</span>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted">Total Ventas:</span>
                                                    <span class="font-weight-bold" id="closeTotalSales">$0</span>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted">Efectivo Esperado:</span>
                                                    <span class="font-weight-bold text-info" id="closeExpectedCash">$0</span>
                                                </div>
                                                <hr class="my-3">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <span class="h6 mb-0">Efectivo Real:</span>
                                                    <div class="input-group" style="width: 200px;">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">$</span>
                                                        </div>
                                                        <input type="number" class="form-control" id="closingCash" step="100" min="0" placeholder="0">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <span class="h6 mb-0">Diferencia:</span>
                                                    <span class="h5 font-weight-bold" id="cashDifference">$0</span>
                                                </div>
                                                
                                                <!-- Campo para notas de cierre -->
                                                <div class="form-group">
                                                    <label for="closingNotes" class="font-weight-bold">
                                                        <i class="fas fa-sticky-note text-info"></i> Notas de Cierre
                                                    </label>
                                                    <textarea class="form-control" id="closingNotes" name="notes" rows="2" placeholder="Observaciones sobre el cierre de caja..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light border-0">
                                        <h6 class="mb-0 text-warning">
                                            <i class="fas fa-chart-bar"></i> Estad铆sticas de Sesi贸n
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="fw-bold text-primary h5" id="closeTotalTransactions">0</div>
                                                <div class="small text-muted">Transacciones</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="fw-bold text-success h5" id="closeTotalItems">0</div>
                                                <div class="small text-muted">Items Vendidos</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="fw-bold text-info h5" id="closeSessionDuration">0h 0m</div>
                                                <div class="small text-muted">Duraci贸n</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panel derecho: Reporte de ventas -->
                        <div class="col-md-6 bg-light">
                            <div class="p-4">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-file-alt"></i> Reporte de Ventas
                                </h6>
                                
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-striped">
                                        <thead class="thead-light sticky-top">
                                            <tr>
                                                <th>Venta</th>
                                                <th>Tipo</th>
                                                <th>Cliente</th>
                                                <th>Total</th>
                                                <th>Hora</th>
                                            </tr>
                                        </thead>
                                        <tbody id="salesReportTable">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin"></i> Cargando reporte...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-3">
                                    <div class="alert alert-warning">
                                        <small>
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>Importante:</strong> Una vez cerrada la caja, no podr谩s realizar m谩s ventas hasta abrir una nueva sesi贸n.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" onclick="closeCashRegister()" id="closeCashBtn">
                        <i class="fas fa-lock"></i> Cerrar Caja
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear cliente -->
    <div class="modal fade modal-nested" id="createCustomerModal" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus"></i> Crear Nuevo Cliente
                    <small class="ml-2">
                        <i class="fas fa-layer-group"></i> Modal Anidada
                    </small>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createCustomerForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="customerFirstName" class="font-weight-bold">
                                    <i class="fas fa-user text-success"></i> Nombre *
                                </label>
                                <input type="text" class="form-control" id="customerFirstName" name="first_name" required placeholder="Ej: Juan">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="customerLastName" class="font-weight-bold">
                                    <i class="fas fa-user text-success"></i> Apellido *
                                </label>
                                <input type="text" class="form-control" id="customerLastName" name="last_name" required placeholder="Ej: P茅rez">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="customerEmail" class="font-weight-bold">
                                    <i class="fas fa-envelope text-success"></i> Email
                                </label>
                                <input type="email" class="form-control" id="customerEmail" name="email" placeholder="juan.perez@email.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="customerPhone" class="font-weight-bold">
                                    <i class="fas fa-phone text-success"></i> Tel茅fono
                                </label>
                                <input type="tel" class="form-control" id="customerPhone" name="phone" placeholder="300 123 4567">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerDocument" class="font-weight-bold">
                            <i class="fas fa-id-card text-success"></i> Documento
                        </label>
                        <input type="text" class="form-control" id="customerDocument" name="document" placeholder="12345678">
                        <small class="form-text text-muted">C茅dula de ciudadan铆a o documento de identidad</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            <strong>Nota:</strong> Los campos marcados con * son obligatorios. 
                            El cliente se crear谩 autom谩ticamente y estar谩 disponible para seleccionar.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="createCustomer()" id="createCustomerBtn">
                    <i class="fas fa-save"></i> Crear Cliente
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Estilos para el selector de tipo de orden */
.btn-group .btn {
    font-size: 0.8rem;
    padding: 0.5rem 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.3s ease;
}

.btn-group .btn.active,
.btn-group .btn:not(.btn-outline-primary):not(.btn-outline-secondary) {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.btn-group .btn i {
    font-size: 0.9rem;
    margin-bottom: 0.1rem;
}

/* Estilos para la modal mejorada */
.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.modal-xl {
    max-width: 1200px;
}

.btn-group-vertical .btn {
    border-radius: 0.375rem !important;
    margin-bottom: 0.25rem;
}

.btn-group-vertical .btn:last-child {
    margin-bottom: 0;
}

.alert-info {
    border-left: 4px solid #17a2b8;
}

.shadow-sm {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

.no-gutters {
    margin-right: 0;
    margin-left: 0;
}

.no-gutters > .col,
.no-gutters > [class*="col-"] {
    padding-right: 0;
    padding-left: 0;
}

/* Estilos para manejar z-index de modales */
.modal {
    z-index: 1050;
}

.modal-backdrop {
    z-index: 1040;
}

/* Modal de procesar venta (modal padre) */
#processSaleModal {
    z-index: 1050;
}

#processSaleModal .modal-backdrop {
    z-index: 1040;
}

/* Modal de crear cliente (modal hija) */
#createCustomerModal {
    z-index: 1070 !important;
}

#createCustomerModal .modal-backdrop {
    z-index: 1060 !important;
}

/* Cuando hay modales anidadas, ajustar el backdrop */
.modal.show + .modal {
    z-index: 1070;
}

.modal.show + .modal .modal-backdrop {
    z-index: 1060;
}

/* Estilos espec铆ficos para modales anidadas */
.modal-nested {
    z-index: 1070 !important;
}

.modal-nested .modal-backdrop {
    z-index: 1060 !important;
}

/* Asegurar que la modal hija est茅 por encima */
body.modal-open .modal.show {
    z-index: 1050;
}

body.modal-open .modal.show + .modal {
    z-index: 1070;
}

/* Estilos para indicador de modal anidada */
.modal-nested .modal-title small {
    opacity: 0.8;
    font-size: 0.7rem;
}

/* Animaci贸n suave para modales anidadas */
.modal-nested.fade .modal-dialog {
    transform: scale(0.8);
    transition: transform 0.3s ease-out;
}

.modal-nested.show .modal-dialog {
    transform: scale(1);
}

/* Sombra m谩s pronunciada para modales anidadas */
.modal-nested .modal-content {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.3);
}

/* Efecto de profundidad visual */
.modal-nested::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.1);
    z-index: 1069;
    pointer-events: none;
}

/* Gradiente para modal de crear cliente */
.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

/* Estilos para modal centrada */
.modal-dialog-centered {
    display: flex;
    align-items: center;
    min-height: calc(100% - 1rem);
}

@media (min-width: 576px) {
    .modal-dialog-centered {
        min-height: calc(100% - 3.5rem);
    }
}

.btn-group .btn small {
    font-size: 0.7rem;
    line-height: 1;
}

/* Indicador visual del tipo de orden */
.order-type-indicator {
    position: relative;
}

.order-type-indicator::after {
    content: '';
    position: absolute;
    top: -2px;
    right: -2px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #28a745;
    border: 2px solid white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentSaleItems = [];
let allProducts = [];
let filteredProducts = [];
let allCustomers = [];
let currentOrderType = 'principal'; // Tipo de orden actual

// Funci贸n para cambiar el tipo de orden
function setOrderType(type) {
    console.log(' Cambiando tipo de orden a:', type);
    currentOrderType = type;
    
    // Actualizar botones
    document.getElementById('btnPrincipal').className = type === 'principal' ? 
        'btn btn-primary btn-sm' : 'btn btn-outline-primary btn-sm';
    document.getElementById('btnAuxiliar').className = type === 'auxiliar' ? 
        'btn btn-secondary btn-sm' : 'btn btn-outline-secondary btn-sm';
    
    // Actualizar informaci贸n
    const infoElement = document.getElementById('orderTypeInfo');
    const processSaleText = document.getElementById('processSaleText');
    
    if (type === 'principal') {
        infoElement.textContent = 'Las 贸rdenes principales incluyen IVA del 19%';
        processSaleText.textContent = 'Procesar Venta Principal';
    } else {
        infoElement.textContent = 'Las 贸rdenes auxiliares no incluyen IVA';
        processSaleText.textContent = 'Procesar Venta Auxiliar';
    }
    
    // Recalcular totales si hay productos
    if (currentSaleItems.length > 0) {
        console.log(' Recalculando totales para', currentSaleItems.length, 'productos');
        updateSaleDisplay();
    }
}

// Cargar productos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    loadCustomers();
    loadWarehouses();
    
    // Formatear total de sesi贸n
    formatSessionTotal();
    
    // Verificar estado de sesi贸n
    checkSessionStatus();
    
    // Event listeners para actualizar totales en la modal
    setTimeout(() => {
        const amountReceived = document.getElementById('amountReceived');
        const discountAmount = document.getElementById('discountAmount');
        
        if (amountReceived) {
            amountReceived.addEventListener('input', updateModalTotals);
        }
        if (discountAmount) {
            discountAmount.addEventListener('input', updateModalTotals);
        }
        
        // Event listener para el bot贸n de cancelar de la modal de crear cliente
        const cancelBtn = document.querySelector('#createCustomerModal .btn-secondary');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                // Restaurar z-index de la modal padre si existe
                setTimeout(() => {
                    const parentModal = document.querySelector('#processSaleModal.show');
                    if (parentModal) {
                        parentModal.style.zIndex = '1050';
                    }
                }, 300);
            });
        }
    }, 500);
});

// Cargar productos desde el servidor
function loadProducts() {
    fetch('/api/products/')
        .then(response => response.json())
        .then(data => {
            allProducts = data;
            filteredProducts = data;
            displayProducts();
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('productsList').innerHTML = `
                <div class="col-12 text-center text-muted">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <div>Error al cargar productos</div>
                </div>
            `;
        });
}

// Mostrar productos en la interfaz
function displayProducts() {
    const container = document.getElementById('productsList');
    
    if (filteredProducts.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center text-muted py-4">
                <i class="fas fa-search fa-2x mb-2"></i>
                <div>No se encontraron productos</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    filteredProducts.forEach(product => {
        const imageUrl = product.image ? `${window.location.origin}${product.image}` : '';
        const stock = product.stock || 0;
        const isAvailable = stock > 0 && product.is_active;
        
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 ${!isAvailable ? 'opacity-50' : ''}" style="cursor: pointer;" 
                     onclick="${isAvailable ? `addToSale(${product.id}, '${product.name}', ${product.price})` : ''}">
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-4">
                                ${imageUrl ? 
                                    `<img src="${imageUrl}" class="img-fluid rounded" style="height: 60px; object-fit: cover;">` :
                                    `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 60px;">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>`
                                }
                            </div>
                            <div class="col-8">
                                <h6 class="card-title mb-1" style="font-size: 0.9rem;">${product.name}</h6>
                                <p class="card-text mb-1">
                                    <small class="text-muted">$${formatCurrency(parseFloat(product.price))}</small>
                                </p>
                                <p class="card-text mb-0">
                                    <small class="badge badge-${stock > 0 ? 'success' : 'danger'}">
                                        Stock: ${stock}
                                    </small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Buscar productos
function searchProducts() {
    const query = document.getElementById('productSearch').value.toLowerCase();
    
    if (query.length < 2) {
        filteredProducts = allProducts;
    } else {
        filteredProducts = allProducts.filter(product => 
            product.name.toLowerCase().includes(query) ||
            product.sku.toLowerCase().includes(query) ||
            (product.barcode && product.barcode.toLowerCase().includes(query))
        );
    }
    
    displayProducts();
}

// Filtrar productos
function filterProducts(filter) {
    // Actualizar botones activos
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
    
    switch(filter) {
        case 'all':
            filteredProducts = allProducts;
            break;
        case 'active':
            filteredProducts = allProducts.filter(p => p.is_active);
            break;
        case 'featured':
            filteredProducts = allProducts.filter(p => p.is_featured && p.is_active);
            break;
    }
    
    displayProducts();
}

function openBarcodeScanner() {
    $('#barcodeModal').modal('show');
}

function searchByBarcode() {
    const barcode = document.getElementById('manualBarcode').value;
    if (barcode) {
        // Aqu铆 ir铆a la b煤squeda por c贸digo de barras
        alert(`Buscando producto con c贸digo: ${barcode}`);
        $('#barcodeModal').modal('hide');
    }
}

// Agregar producto a la venta
function addToSale(productId, productName, price) {
    const existingItem = currentSaleItems.find(item => item.productId === productId);
    
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        currentSaleItems.push({
            productId: productId,
            productName: productName,
            price: parseFloat(price),
            quantity: 1
        });
    }
    
    updateSaleDisplay();
    showNotification(`${productName} agregado a la venta`, 'success');
}

// Venta r谩pida (solo efectivo)
function quickSale() {
    if (currentSaleItems.length === 0) {
        showNotification('No hay productos en la venta', 'warning');
        return;
    }
    
    const total = calculateTotal();
    const amountReceived = prompt(`Total: $${formatCurrency(total)}\nMonto recibido:`, total);
    
    if (amountReceived && parseFloat(amountReceived) >= total) {
        processQuickSale(parseFloat(amountReceived));
    }
}

// Procesar venta r谩pida
function processQuickSale(amountReceived) {
    const change = amountReceived - calculateTotal();
    
    if (confirm(`Total: $${formatCurrency(calculateTotal())}\nRecibido: $${formatCurrency(amountReceived)}\nCambio: $${formatCurrency(change)}\n\n驴Confirmar venta?`)) {
        // Aqu铆 ir铆a la l贸gica para procesar la venta
        showNotification('Venta procesada correctamente', 'success');
        clearSale();
        refreshSales(); // Actualizar lista de ventas
    }
}

// Mostrar notificaci贸n
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function removeFromSale(productId) {
    currentSaleItems = currentSaleItems.filter(item => item.productId !== productId);
    updateSaleDisplay();
}

function updateQuantity(productId, newQuantity) {
    const item = currentSaleItems.find(item => item.productId === productId);
    if (item) {
        if (newQuantity <= 0) {
            removeFromSale(productId);
        } else {
            item.quantity = newQuantity;
            updateSaleDisplay();
        }
    }
}

// Actualizar display de la venta
function updateSaleDisplay() {
    const container = document.getElementById('saleItems');
    const processBtn = document.getElementById('processSaleBtn');
    const itemCount = document.getElementById('itemCount');
    
    if (currentSaleItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                <div>Agrega productos para comenzar</div>
            </div>
        `;
        processBtn.disabled = true;
        itemCount.textContent = '0 items';
        updateTotals();
        return;
    }
    
    let html = '';
    let totalItems = 0;
    
    currentSaleItems.forEach(item => {
        totalItems += item.quantity;
        const itemTotal = item.price * item.quantity;
        
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-light">
                <div class="flex-grow-1">
                    <div class="fw-bold" style="font-size: 0.9rem;">${item.productName}</div>
                    <div class="text-muted small">$${formatCurrency(item.price)} c/u</div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${item.productId}, ${item.quantity - 1})">-</button>
                        <span class="btn btn-outline-secondary disabled">${item.quantity}</span>
                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${item.productId}, ${item.quantity + 1})">+</button>
                    </div>
                    <button class="btn btn-outline-danger btn-sm ml-2" onclick="removeFromSale(${item.productId})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    processBtn.disabled = false;
    itemCount.textContent = `${totalItems} items`;
    updateTotals();
}

// Calcular total
function calculateTotal() {
    let subtotal = 0;
    currentSaleItems.forEach(item => {
        subtotal += item.price * item.quantity;
    });
    
    // Calcular IVA seg煤n el tipo de orden
    const hasIva = currentOrderType === 'principal';
    const tax = hasIva ? subtotal * 0.19 : 0;
    
    return subtotal + tax;
}

// Actualizar totales
function updateTotals() {
    console.log(' updateTotals() EJECUTNDOSE AHORA');
    console.log(' currentOrderType:', currentOrderType);
    console.log(' currentSaleItems:', currentSaleItems);
    
    let subtotal = 0;
    currentSaleItems.forEach(item => {
        subtotal += item.price * item.quantity;
    });
    
    // Calcular IVA seg煤n el tipo de orden
    const hasIva = currentOrderType === 'principal';
    const tax = hasIva ? subtotal * 0.19 : 0;
    const total = subtotal + tax;
    
    console.log('М C谩lculos:', {
        subtotal: subtotal,
        hasIva: hasIva,
        tax: tax,
        total: total
    });
    
    // Actualizar etiqueta del IVA usando ID directo
    const taxLabel = document.getElementById('taxLabel');
    if (taxLabel) {
        const newLabelText = hasIva ? 'IVA (19%):' : 'IVA (0%):';
        taxLabel.textContent = newLabelText;
        console.log('凤 Etiqueta IVA actualizada:', newLabelText);
    } else {
        console.error(' No se encontr贸 taxLabel');
    }
    
    // Actualizar valores num茅ricos
    const subtotalElement = document.getElementById('subtotal');
    const taxElement = document.getElementById('tax');
    const totalElement = document.getElementById('total');
    
    if (subtotalElement) {
        subtotalElement.textContent = `$${formatCurrency(subtotal)}`;
        console.log(' Subtotal actualizado:', `$${formatCurrency(subtotal)}`);
    } else {
        console.error(' No se encontr贸 subtotal');
    }
    
    if (taxElement) {
        taxElement.textContent = `$${formatCurrency(tax)}`;
        console.log('Ь Tax actualizado:', `$${formatCurrency(tax)}`);
    } else {
        console.error(' No se encontr贸 tax');
    }
    
    if (totalElement) {
        totalElement.textContent = `$${formatCurrency(total)}`;
        console.log(' Total actualizado:', `$${formatCurrency(total)}`);
    } else {
        console.error(' No se encontr贸 total');
    }
}

function processSale() {
    if (currentSaleItems.length === 0) return;
    
    // Verificar que haya una sesi贸n activa
    if (!currentSession) {
        showNotification('Debes abrir la caja antes de procesar ventas', 'error');
        openCashModal();
        return;
    }
    
    $('#processSaleModal').modal('show');
}

function confirmSale() {
    // Aqu铆 ir铆a la l贸gica para procesar la venta
    alert('Venta procesada correctamente');
    $('#processSaleModal').modal('hide');
    clearSale();
}

// Limpiar venta
function clearSale() {
    if (currentSaleItems.length === 0) {
        showNotification('No hay productos en la venta', 'warning');
        return;
    }
    
    if (confirm('驴Est谩s seguro de que quieres limpiar la venta?')) {
        currentSaleItems = [];
        updateSaleDisplay();
        showNotification('Venta limpiada', 'info');
    }
}

// Cerrar sesi贸n
function closeSession() {
    if (confirm('驴Est谩s seguro de que quieres cerrar la sesi贸n de POS?')) {
        // Aqu铆 ir铆a la l贸gica para cerrar la sesi贸n
        showNotification('Sesi贸n cerrada correctamente', 'success');
        setTimeout(() => {
            location.reload();
        }, 1500);
    }
}

// Ver venta
function viewSale(saleId) {
    // Redirigir a la p谩gina de detalle de la venta POS
    window.open(`/admin-custom/pos-sale/${saleId}/`, '_blank');
}

// Imprimir recibo
function printReceipt(saleId) {
    // Redirigir a la p谩gina de impresi贸n del recibo POS
    window.open(`/admin-custom/pos-sale/${saleId}/print/`, '_blank');
}

// Actualizar ventas
function refreshSales() {
    console.log(' Iniciando actualizaci贸n de ventas...');
    showNotification('Actualizando ventas...', 'info');
    
    // Obtener ventas recientes via API
    fetch('/api/pos/sales/')
        .then(response => {
            console.log(' Respuesta de API:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(sales => {
            console.log(' Datos recibidos:', sales);
            updateSalesTable(sales);
            showNotification('Ventas actualizadas', 'success');
        })
        .catch(error => {
            console.error(' Error al actualizar ventas:', error);
            showNotification(`Error al actualizar ventas: ${error.message}`, 'error');
        });
}

// Funci贸n para actualizar la tabla de ventas
function updateSalesTable(sales) {
    console.log(' Actualizando tabla de ventas con:', sales);
    
    const tbody = document.querySelector('#salesTable tbody');
    if (!tbody) {
        console.error(' No se encontr贸 el tbody de la tabla de ventas');
        return;
    }
    
    if (!sales || sales.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-receipt fa-2x mb-2"></i>
                    <div>No hay ventas en esta sesi贸n</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = sales.map(sale => {
        console.log(' Procesando venta:', sale);
        
        const timeString = new Date(sale.created_at).toLocaleTimeString('es-CO', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const customerName = sale.customer ? 
            (sale.customer.full_name || sale.customer.user?.username || 'Cliente') : 
            '<span class="text-muted">General</span>';
        
        const paymentMethodClass = sale.payment_method === 'cash' ? 'success' : 
                                 sale.payment_method === 'card' ? 'primary' : 'info';
        
        const itemsCount = sale.items ? sale.items.length : 0;
        
        return `
            <tr>
                <td><strong>#${sale.sale_number}</strong></td>
                <td>${timeString}</td>
                <td>${customerName}</td>
                <td><span class="badge badge-info">${itemsCount}</span></td>
                <td><strong>$${formatCurrency(sale.total)}</strong></td>
                <td>
                    <span class="badge badge-${paymentMethodClass}">
                        ${sale.payment_method_display || sale.payment_method}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewSale(${sale.id})" title="Ver">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="printReceipt(${sale.id})" title="Imprimir">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    console.log(' Tabla de ventas actualizada');
}

// Atajos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl + Enter para venta r谩pida
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        quickSale();
    }
    
    // Escape para limpiar venta
    if (e.key === 'Escape') {
        e.preventDefault();
        clearSale();
    }
    
    // F1 para buscar productos
    if (e.key === 'F1') {
        e.preventDefault();
        document.getElementById('productSearch').focus();
    }
});

// ===== NUEVAS FUNCIONES MEJORADAS =====

// Cargar clientes desde el servidor
function loadCustomers() {
    console.log('Cargando clientes...');
    fetch('/api/customers/customers/')
        .then(response => response.json())
        .then(data => {
            console.log('Datos recibidos:', data);
            // La API devuelve datos paginados, necesitamos acceder a 'results'
            allCustomers = data.results || data;
            console.log('Clientes procesados:', allCustomers.length);
            updateCustomerSelect();
        })
        .catch(error => {
            console.error('Error al cargar clientes:', error);
        });
}

// Actualizar select de clientes
function updateCustomerSelect() {
    console.log('Actualizando select de clientes...');
    const select = document.getElementById('customerSelect');
    if (!select) {
        console.log('Select no encontrado');
        return;
    }
    
    select.innerHTML = '<option value="">Cliente general</option>';
    console.log('Agregando', allCustomers.length, 'clientes al select');
    
    allCustomers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.full_name} (${customer.email || 'Sin email'})`;
        select.appendChild(option);
    });
    
    console.log('Reinicializando Select2...');
    // Reinicializar Select2
    $('#customerSelect').select2('destroy').select2({
        placeholder: 'Seleccionar cliente...',
        allowClear: true,
        width: '100%'
    });
    console.log('Select2 inicializado');
}

// Inicializar Select2
function initializeSelect2() {
    $('#customerSelect').select2({
        placeholder: 'Seleccionar cliente...',
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return "No se encontraron clientes";
            },
            searching: function() {
                return "Buscando...";
            }
        }
    });
}

// Establecer monto exacto
function setExactAmount() {
    const total = parseFloat(document.getElementById('modalTotal').textContent.replace('$', '').replace(',', ''));
    document.getElementById('amountReceived').value = total;
    updateModalTotals();
}

// Actualizar totales en modal
function updateModalTotals() {
    const amountReceived = parseFloat(document.getElementById('amountReceived').value) || 0;
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
    const total = parseFloat(document.getElementById('modalTotal').textContent.replace('$', '').replace(',', ''));
    
    const finalTotal = total - discount;
    const change = amountReceived - finalTotal;
    
    document.getElementById('modalReceived').textContent = `$${formatCurrency(amountReceived)}`;
    document.getElementById('modalChange').textContent = `$${formatCurrency(change)}`;
    
    // Cambiar color del cambio
    const changeElement = document.getElementById('modalChange');
    if (change >= 0) {
        changeElement.className = 'text-success';
    } else {
        changeElement.className = 'text-danger';
    }
}

// Abrir modal de crear cliente
function openCreateCustomerModal() {
    // Limpiar formulario
    document.getElementById('createCustomerForm').reset();
    
    // Verificar si hay una modal padre abierta
    const parentModal = document.querySelector('#processSaleModal.show');
    
    if (parentModal) {
        // Si hay modal padre, usar configuraci贸n especial para modales anidadas
        $('#createCustomerModal').modal({
            backdrop: 'static',
            keyboard: false,
            show: true
        });
        
        // Ajustar z-index din谩micamente
        setTimeout(() => {
            const customerModal = document.getElementById('createCustomerModal');
            if (customerModal) {
                customerModal.style.zIndex = '1070';
                const backdrop = document.querySelector('#createCustomerModal + .modal-backdrop');
                if (backdrop) {
                    backdrop.style.zIndex = '1060';
                }
            }
        }, 100);
    } else {
        // Si no hay modal padre, usar configuraci贸n normal
        $('#createCustomerModal').modal({
            backdrop: 'static',
            keyboard: false,
            show: true
        });
    }
    
    // Enfocar el primer campo
    setTimeout(() => {
        document.getElementById('customerFirstName').focus();
    }, 300);
}

// Crear cliente
function createCustomer() {
    const createBtn = document.getElementById('createCustomerBtn');
    const originalText = createBtn.innerHTML;
    
    // Deshabilitar bot贸n y mostrar loading
    createBtn.disabled = true;
    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
    
    const formData = {
        first_name: document.getElementById('customerFirstName').value.trim(),
        last_name: document.getElementById('customerLastName').value.trim(),
        email: document.getElementById('customerEmail').value.trim(),
        phone: document.getElementById('customerPhone').value.trim(),
        document: document.getElementById('customerDocument').value.trim()
    };
    
    // Validaciones
    if (!formData.first_name || !formData.last_name) {
        showNotification('Nombre y apellido son obligatorios', 'error');
        createBtn.disabled = false;
        createBtn.innerHTML = originalText;
        return;
    }
    
    // Validar email si se proporciona
    if (formData.email && !isValidEmail(formData.email)) {
        showNotification('El formato del email no es v谩lido', 'error');
        createBtn.disabled = false;
        createBtn.innerHTML = originalText;
        return;
    }
    
    fetch('/api/customers/customers/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
            });
        }
        return response.json();
    })
    .then(data => {
        // Agregar nuevo cliente a la lista
        allCustomers.push(data);
        updateCustomerSelect();
        
        // Seleccionar el cliente reci茅n creado
        $('#customerSelect').val(data.id).trigger('change');
        
        // Cerrar modal de crear cliente
        $('#createCustomerModal').modal('hide');
        document.getElementById('createCustomerForm').reset();
        
        // Verificar si hay modal padre y restaurar su z-index
        setTimeout(() => {
            const parentModal = document.querySelector('#processSaleModal.show');
            if (parentModal) {
                parentModal.style.zIndex = '1050';
            }
        }, 300);
        
        showNotification('Cliente creado exitosamente', 'success');
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification(`Error al crear cliente: ${error.message}`, 'error');
    })
    .finally(() => {
        // Restaurar bot贸n
        createBtn.disabled = false;
        createBtn.innerHTML = originalText;
    });
}

// Funci贸n para validar email
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Funci贸n para formatear n煤meros en formato colombiano
function formatCurrency(amount) {
    return new Intl.NumberFormat('es-CO', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// Funci贸n para formatear el total de la sesi贸n
function formatSessionTotal() {
    const sessionTotalElement = document.getElementById('sessionTotal');
    if (sessionTotalElement) {
        const currentText = sessionTotalElement.textContent;
        const amount = parseFloat(currentText.replace('$', '').replace(',', ''));
        if (!isNaN(amount)) {
            sessionTotalElement.textContent = `$${formatCurrency(amount)}`;
        }
    }
}

// Variables globales para sesi贸n
let currentSession = null;
let allWarehouses = [];

// Funci贸n para cargar bodegas
function loadWarehouses() {
    fetch('/api/pos/warehouses/')
        .then(response => response.json())
        .then(data => {
            allWarehouses = data;
            updateWarehouseSelect();
        })
        .catch(error => {
            console.error('Error al cargar bodegas:', error);
        });
}

// Funci贸n para actualizar el select de bodegas
function updateWarehouseSelect() {
    const warehouseSelect = document.getElementById('warehouseSelect');
    if (warehouseSelect) {
        warehouseSelect.innerHTML = '<option value="">Seleccionar bodega...</option>';
        allWarehouses.forEach(warehouse => {
            const option = document.createElement('option');
            option.value = warehouse.id;
            option.textContent = `${warehouse.name} (${warehouse.city})`;
            warehouseSelect.appendChild(option);
        });
    }
}

// Funci贸n para verificar estado de sesi贸n
function checkSessionStatus() {
    fetch('/api/pos/session/status/')
        .then(response => response.json())
        .then(data => {
            if (data.has_active_session) {
                currentSession = data.session;
                showCloseCashButton();
                updateSessionInfo(data.session);
            } else {
                currentSession = null;
                showOpenCashButton();
            }
        })
        .catch(error => {
            console.error('Error al verificar sesi贸n:', error);
            showOpenCashButton();
        });
}

// Funci贸n para mostrar bot贸n de abrir caja
function showOpenCashButton() {
    document.getElementById('openCashButton').style.display = 'block';
    document.getElementById('closeCashButton').style.display = 'none';
}

// Funci贸n para mostrar bot贸n de cerrar caja
function showCloseCashButton() {
    document.getElementById('openCashButton').style.display = 'none';
    document.getElementById('closeCashButton').style.display = 'block';
}

// Funci贸n para actualizar informaci贸n de sesi贸n
function updateSessionInfo(session) {
    // Actualizar el resumen de sesi贸n si existe
    const sessionStats = document.querySelector('.card-body .row');
    if (sessionStats) {
        const totalElement = sessionStats.querySelector('.col-4:nth-child(2) .fw-bold');
        if (totalElement) {
            totalElement.textContent = formatCurrency(session.current_sales || 0);
        }
    }
    
    // Actualizar informaci贸n adicional si est谩 disponible
    if (session.warehouse) {
        console.log('Sesi贸n activa en:', session.warehouse.name, session.warehouse.city);
    }
}

// Funci贸n para abrir modal de caja
function openCashModal() {
    $('#openCashModal').modal({
        backdrop: 'static',
        keyboard: false,
        show: true
    });
}

// Funci贸n para abrir caja
function openCashRegister() {
    const openBtn = document.getElementById('openCashBtn');
    const originalText = openBtn.innerHTML;
    
    openBtn.disabled = true;
    openBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Abriendo...';
    
    const warehouseId = document.getElementById('warehouseSelect').value;
    const openingCash = parseFloat(document.getElementById('openingCash').value) || 0;
    const notes = document.getElementById('sessionNotes').value;
    
    console.log('Abriendo caja:', { warehouseId, openingCash, notes });
    
    if (!warehouseId) {
        showNotification('Selecciona una bodega', 'error');
        openBtn.disabled = false;
        openBtn.innerHTML = originalText;
        return;
    }
    
    const formData = {
        warehouse_id: parseInt(warehouseId),
        opening_cash: openingCash,
        notes: notes
    };
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    console.log('CSRF Token:', csrfToken ? csrfToken.value : 'No encontrado');
    
    fetch('/api/pos/session/open/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken ? csrfToken.value : ''
        },
        body: new URLSearchParams(formData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            currentSession = data.session;
            showCloseCashButton();
            updateSessionInfo(data.session);
            $('#openCashModal').modal('hide');
            document.getElementById('openCashForm').reset();
            showNotification('Caja abierta exitosamente', 'success');
        } else {
            showNotification(data.error || 'Error al abrir caja', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al abrir caja', 'error');
    })
    .finally(() => {
        openBtn.disabled = false;
        openBtn.innerHTML = originalText;
    });
}

// Funci贸n para abrir modal de cerrar caja
function closeCashModal() {
    if (!currentSession) {
        showNotification('No hay sesi贸n activa', 'error');
        return;
    }
    
    // Cargar datos de la sesi贸n
    loadSessionData();
    
    $('#closeCashModal').modal({
        backdrop: 'static',
        keyboard: false,
        show: true
    });
}

// Funci贸n para cargar datos de la sesi贸n
function loadSessionData() {
    fetch('/api/pos/session/status/')
        .then(response => response.json())
        .then(data => {
            if (data.has_active_session) {
                const session = data.session;
                const statistics = data.statistics;
                
                // Actualizar resumen de caja
                document.getElementById('closeOpeningCash').textContent = `$${formatCurrency(session.opening_cash)}`;
                document.getElementById('closeTotalSales').textContent = `$${formatCurrency(session.current_sales)}`;
                document.getElementById('closeExpectedCash').textContent = `$${formatCurrency(session.expected_cash)}`;
                document.getElementById('closeTotalTransactions').textContent = session.current_transactions;
                document.getElementById('closeTotalItems').textContent = session.current_items_sold;
                document.getElementById('closeSessionDuration').textContent = session.duration;
                
                // Cargar reporte de ventas
                loadSalesReport();
            }
        })
        .catch(error => {
            console.error('Error al cargar datos de sesi贸n:', error);
        });
}

// Funci贸n para cargar reporte de ventas
function loadSalesReport() {
    fetch('/api/pos/sales/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('salesReportTable');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay ventas registradas</td></tr>';
                return;
            }
            
            data.forEach(sale => {
                const row = document.createElement('tr');
                const createdDate = new Date(sale.created_at);
                const timeString = createdDate.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                
                row.innerHTML = `
                    <td>${sale.sale_number}</td>
                    <td><span class="badge badge-${sale.order_type === 'principal' ? 'primary' : 'secondary'}">${sale.order_type === 'principal' ? 'Principal' : 'Auxiliar'}</span></td>
                    <td>${sale.customer ? sale.customer.full_name : 'Cliente general'}</td>
                    <td>$${formatCurrency(sale.total)}</td>
                    <td>${timeString}</td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error al cargar reporte:', error);
            const tbody = document.getElementById('salesReportTable');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar reporte</td></tr>';
        });
}

// Funci贸n para cerrar caja
function closeCashRegister() {
    const closeBtn = document.getElementById('closeCashBtn');
    const originalText = closeBtn.innerHTML;
    
    closeBtn.disabled = true;
    closeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cerrando...';
    
    const closingCash = parseFloat(document.getElementById('closingCash').value) || 0;
    const notes = document.getElementById('closingNotes').value;
    
    const formData = {
        closing_cash: closingCash,
        notes: notes
    };
    
    fetch('/api/pos/session/close/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentSession = null;
            showOpenCashButton();
            $('#closeCashModal').modal('hide');
            showNotification('Caja cerrada exitosamente', 'success');
            
            // Mostrar resumen final
            showCloseSummary(data.session, data.sales_report);
        } else {
            showNotification(data.error || 'Error al cerrar caja', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al cerrar caja', 'error');
    })
    .finally(() => {
        closeBtn.disabled = false;
        closeBtn.innerHTML = originalText;
    });
}

// Funci贸n para mostrar resumen de cierre
function showCloseSummary(session, salesReport) {
    const summary = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> Caja Cerrada Exitosamente</h6>
            <hr>
            <div class="row">
                <div class="col-6">
                    <strong>Efectivo Inicial:</strong> $${formatCurrency(session.opening_cash)}<br>
                    <strong>Total Ventas:</strong> $${formatCurrency(session.total_sales)}<br>
                    <strong>Efectivo Esperado:</strong> $${formatCurrency(session.expected_cash)}
                </div>
                <div class="col-6">
                    <strong>Efectivo Real:</strong> $${formatCurrency(session.closing_cash)}<br>
                    <strong>Diferencia:</strong> $${formatCurrency(session.cash_difference)}<br>
                    <strong>Transacciones:</strong> ${session.total_transactions}
                </div>
            </div>
        </div>
    `;
    
    showNotification(summary, 'success', 10000);
}

// Event listener para calcular diferencia de caja
document.addEventListener('DOMContentLoaded', function() {
    const closingCashInput = document.getElementById('closingCash');
    if (closingCashInput) {
        closingCashInput.addEventListener('input', function() {
            const closingCash = parseFloat(this.value) || 0;
            const expectedCashElement = document.getElementById('closeExpectedCash');
            if (expectedCashElement) {
                const expectedCash = parseFloat(expectedCashElement.textContent.replace('$', '').replace(',', ''));
                const difference = closingCash - expectedCash;
                const differenceElement = document.getElementById('cashDifference');
                
                differenceElement.textContent = `$${formatCurrency(difference)}`;
                
                // Cambiar color seg煤n la diferencia
                if (difference > 0) {
                    differenceElement.className = 'h5 font-weight-bold text-success';
                } else if (difference < 0) {
                    differenceElement.className = 'h5 font-weight-bold text-danger';
                } else {
                    differenceElement.className = 'h5 font-weight-bold text-info';
                }
            }
        });
    }
});

// Mejorar funci贸n processSale
function processSale() {
    if (currentSaleItems.length === 0) return;
    
    const subtotal = currentSaleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const hasIva = currentOrderType === 'principal';
    const tax = hasIva ? subtotal * 0.19 : 0;
    const total = subtotal + tax;
    
    // Actualizar modal con totales
    document.getElementById('modalSubtotal').textContent = `$${formatCurrency(subtotal)}`;
    document.getElementById('modalTax').textContent = `$${formatCurrency(tax)}`;
    document.getElementById('modalTotal').textContent = `$${formatCurrency(total)}`;
    document.getElementById('modalItems').textContent = currentSaleItems.length;
    
    // Actualizar etiqueta del IVA seg煤n el tipo usando ID directo
    const modalTaxLabel = document.getElementById('modalTaxLabel');
    if (modalTaxLabel) {
        modalTaxLabel.textContent = hasIva ? 'IVA (19%):' : 'IVA (0%):';
    }
    
    // Actualizar informaci贸n del tipo de orden en la modal
    const modalOrderTypeInfo = document.getElementById('modalOrderTypeInfo');
    if (modalOrderTypeInfo) {
        modalOrderTypeInfo.textContent = currentOrderType === 'principal' ? 
            'Principal (Con IVA)' : 'Auxiliar (Sin IVA)';
    }
    
    // Establecer timestamp
    const modalTimestamp = document.getElementById('modalTimestamp');
    if (modalTimestamp) {
        modalTimestamp.textContent = new Date().toLocaleString();
    }
    
    // Limpiar campos
    document.getElementById('amountReceived').value = '';
    document.getElementById('discountAmount').value = '';
    document.getElementById('saleNotes').value = '';
    $('#customerSelect').val('').trigger('change');
    
    $('#processSaleModal').modal('show');
}

// Funci贸n para formatear entrada de monto
function formatAmountInput(input) {
    let value = input.value.replace(/[^\d]/g, ''); // Solo n煤meros
    if (value === '') {
        input.value = '';
        return;
    }
    
    // Convertir a n煤mero y formatear
    const number = parseInt(value);
    input.value = formatCurrency(number);
    updateModalTotals();
}

// Funci贸n para validar entrada de monto
function validateAmountInput(input) {
    let value = input.value.replace(/[^\d]/g, ''); // Solo n煤meros
    if (value === '') {
        input.value = '';
        return;
    }
    
    // Convertir a n煤mero y formatear
    const number = parseInt(value);
    input.value = formatCurrency(number);
}

// Funci贸n para obtener valor num茅rico del campo formateado
function getAmountValue(inputId) {
    const input = document.getElementById(inputId);
    const value = input.value.replace(/[^\d]/g, ''); // Solo n煤meros
    return value === '' ? 0 : parseInt(value);
}

// Funci贸n para establecer monto recibido r谩pidamente
function setAmountReceived(amount) {
    document.getElementById('amountReceived').value = formatCurrency(amount);
    updateModalTotals();
}

// Funci贸n para establecer monto exacto (igual al total)
function setExactAmount() {
    const totalElement = document.getElementById('modalTotal');
    if (totalElement) {
        const totalText = totalElement.textContent;
        const totalValue = parseFloat(totalText.replace('$', '').replace(/\./g, ''));
        document.getElementById('amountReceived').value = formatCurrency(totalValue);
        updateModalTotals();
    }
}

// Funci贸n para actualizar totales en la modal
function updateModalTotals() {
    const amountReceived = getAmountValue('amountReceived');
    const discount = getAmountValue('discountAmount');
    const totalElement = document.getElementById('modalTotal');
    
    if (totalElement) {
        const totalText = totalElement.textContent;
        const total = parseFloat(totalText.replace('$', '').replace(/\./g, ''));
        const change = amountReceived - total;
        
        // Actualizar monto recibido y cambio
        document.getElementById('modalReceived').textContent = `$${formatCurrency(amountReceived)}`;
        document.getElementById('modalChange').textContent = `$${formatCurrency(change)}`;
        
        // Cambiar color del cambio seg煤n si es positivo o negativo
        const changeElement = document.getElementById('modalChange');
        if (change >= 0) {
            changeElement.className = 'font-weight-bold text-success';
        } else {
            changeElement.className = 'font-weight-bold text-danger';
        }
    }
}

// Mejorar funci贸n confirmSale
function confirmSale() {
    const customerId = document.getElementById('customerSelect').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const amountReceived = getAmountValue('amountReceived');
    const discount = getAmountValue('discountAmount');
    const notes = document.getElementById('saleNotes').value;
    
    const saleData = {
        customer_id: customerId || null,
        payment_method: paymentMethod,
        order_type: currentOrderType, // Usar el tipo actual
        amount_received: amountReceived,
        discount: discount,
        notes: notes,
        items: currentSaleItems.map(item => ({
            product_id: item.productId,
            quantity: item.quantity,
            unit_price: item.price
        }))
    };
    
    // Mostrar loading
    const confirmBtn = document.getElementById('confirmSaleBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    confirmBtn.disabled = true;
    
    // Log de datos que se env铆an
    console.log(' Enviando datos de venta:', saleData);
    
    // Verificar stock antes de la venta
    const stockBeforeSale = {};
    currentSaleItems.forEach(item => {
        const productCard = document.querySelector(`[data-product-id="${item.productId}"]`);
        if (productCard) {
            const stockElement = productCard.querySelector('.stock-quantity');
            if (stockElement) {
                stockBeforeSale[item.productId] = parseInt(stockElement.textContent) || 0;
                console.log(` Stock antes de venta - ${item.productName}: ${stockBeforeSale[item.productId]}`);
            }
        }
    });
    
    // Enviar a la API
    fetch('/api/pos/sales/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(saleData)
    })
    .then(response => {
        console.log(' Respuesta de API:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log(' Datos recibidos de la API:', data);
        
        if (data.error) {
            showNotification(data.error, 'error');
        } else {
            showNotification(`Venta ${data.sale_number} procesada exitosamente`, 'success');
            $('#processSaleModal').modal('hide');
            clearSale();
            
            // Verificar stock despu茅s de la venta
            setTimeout(() => {
                verifyInventoryDeduction(stockBeforeSale);
            }, 1000);
            
            loadProducts(); // Recargar productos para actualizar stock
            refreshSales(); // Actualizar lista de ventas
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al procesar la venta', 'error');
    })
    .finally(() => {
        // Restaurar bot贸n
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// Funci贸n para verificar que el inventario se haya descontado correctamente
function verifyInventoryDeduction(stockBeforeSale) {
    console.log(' Verificando descuento de inventario...');
    
    let allCorrect = true;
    const verificationResults = [];
    
    currentSaleItems.forEach(item => {
        const productCard = document.querySelector(`[data-product-id="${item.productId}"]`);
        if (productCard) {
            const stockElement = productCard.querySelector('.stock-quantity');
            if (stockElement) {
                const stockAfterSale = parseInt(stockElement.textContent) || 0;
                const expectedStock = stockBeforeSale[item.productId] - item.quantity;
                
                const isCorrect = stockAfterSale === expectedStock;
                allCorrect = allCorrect && isCorrect;
                
                const result = {
                    product: item.productName,
                    stockBefore: stockBeforeSale[item.productId],
                    quantitySold: item.quantity,
                    expectedStock: expectedStock,
                    actualStock: stockAfterSale,
                    isCorrect: isCorrect
                };
                
                verificationResults.push(result);
                
                console.log(` ${item.productName}:`);
                console.log(`   Stock antes: ${stockBeforeSale[item.productId]}`);
                console.log(`   Cantidad vendida: ${item.quantity}`);
                console.log(`   Stock esperado: ${expectedStock}`);
                console.log(`   Stock actual: ${stockAfterSale}`);
                console.log(`    Correcto: ${isCorrect ? 'S' : 'NO'}`);
            }
        }
    });
    
    // Mostrar resumen
    if (allCorrect) {
        console.log(' 隆Inventario descontado correctamente!');
        showNotification(' Inventario actualizado correctamente', 'success');
    } else {
        console.log(' Problemas detectados en el descuento de inventario');
        showNotification('锔 Verificar descuento de inventario', 'warning');
        
        // Mostrar detalles de los problemas
        verificationResults.forEach(result => {
            if (!result.isCorrect) {
                console.error(` ${result.product}: Esperado ${result.expectedStock}, Actual ${result.actualStock}`);
            }
        });
    }
    
    return verificationResults;
}

// Funci贸n para probar el inventario manualmente
function testInventoryDeduction() {
    console.log('И Iniciando prueba de descuento de inventario...');
    
    if (currentSaleItems.length === 0) {
        showNotification('No hay productos en la venta para probar', 'warning');
        return;
    }
    
    // Capturar stock actual
    const currentStock = {};
    currentSaleItems.forEach(item => {
        const productCard = document.querySelector(`[data-product-id="${item.productId}"]`);
        if (productCard) {
            const stockElement = productCard.querySelector('.stock-quantity');
            if (stockElement) {
                currentStock[item.productId] = {
                    name: item.productName,
                    stock: parseInt(stockElement.textContent) || 0,
                    quantity: item.quantity
                };
            }
        }
    });
    
    console.log(' Stock actual capturado:', currentStock);
    
    // Simular una venta peque帽a para probar
    const testSaleData = {
        customer_id: null,
        payment_method: 'cash',
        order_type: 'principal',
        amount_received: 1000,
        discount: 0,
        notes: 'Prueba de inventario',
        items: currentSaleItems.map(item => ({
            product_id: item.productId,
            quantity: 1, // Solo vender 1 unidad para la prueba
            unit_price: item.price
        }))
    };
    
    console.log(' Enviando venta de prueba:', testSaleData);
    
    fetch('/api/pos/sales/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(testSaleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error(' Error en venta de prueba:', data.error);
            showNotification(`Error en prueba: ${data.error}`, 'error');
        } else {
            console.log(' Venta de prueba exitosa:', data);
            showNotification(' Prueba de inventario completada', 'success');
            
            // Verificar el inventario despu茅s de la prueba
            setTimeout(() => {
                loadProducts();
                setTimeout(() => {
                    verifyInventoryDeduction(currentStock);
                }, 500);
            }, 1000);
        }
    })
    .catch(error => {
        console.error(' Error en prueba:', error);
        showNotification('Error en prueba de inventario', 'error');
    });
}

// Funci贸n para cargar ventas iniciales
function loadInitialSales() {
    console.log(' Cargando ventas iniciales...');
    refreshSales();
}

// Event listeners adicionales para la modal (sin DOMContentLoaded duplicado)
// Cargar clientes cuando se carga la p谩gina
loadCustomers();

// Cargar ventas iniciales cuando se carga la p谩gina
document.addEventListener('DOMContentLoaded', function() {
    console.log(' P谩gina cargada, iniciando carga de ventas...');
    setTimeout(loadInitialSales, 1000); // Esperar 1 segundo para que todo est茅 listo
});
    
    // Inicializar Select2
    setTimeout(initializeSelect2, 100);
    
    // Event listeners para campos de la modal
    const amountReceived = document.getElementById('amountReceived');
    const discountAmount = document.getElementById('discountAmount');
    const paymentMethod = document.getElementById('paymentMethod');
    
    if (amountReceived) {
        amountReceived.addEventListener('input', updateModalTotals);
    }
    if (discountAmount) {
        discountAmount.addEventListener('input', updateModalTotals);
    }
    if (paymentMethod) {
        paymentMethod.addEventListener('change', function() {
            if (this.value === 'cash') {
                document.getElementById('amountReceived').disabled = false;
            } else {
                document.getElementById('amountReceived').disabled = true;
                document.getElementById('amountReceived').value = '';
                updateModalTotals();
            }
        });
    }
</script>
{% endblock %}

