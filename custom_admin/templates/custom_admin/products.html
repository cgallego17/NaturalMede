{% extends 'custom_admin/base.html' %}
{% load static %}

{% block title %}Gestión de Productos - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-box"></i> Gestión de Productos</h2>
                <div class="btn-group" role="group">
                    <a href="{% url 'custom_admin:admin_categories' %}" class="btn btn-outline-success">
                        <i class="fas fa-folder"></i> Categorías
                    </a>
                    <a href="{% url 'custom_admin:admin_brands' %}" class="btn btn-outline-warning">
                        <i class="fas fa-star"></i> Marcas
                    </a>
                    <a href="{% url 'custom_admin:admin_product_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </a>
                </div>
            </div>

            <!-- Filtros simplificados -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <!-- Filtros principales -->
                        <div class="col-md-4">
                            <input type="text" class="form-control" name="search" 
                                   placeholder="Buscar productos..." value="{{ current_search|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" name="category">
                                <option value="">Todas las categorías</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}" 
                                            {% if current_category|default:'' == category.id|stringformat:"s" %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" name="brand">
                                <option value="">Todas las marcas</option>
                                {% for brand in brands %}
                                    <option value="{{ brand.id }}" 
                                            {% if current_brand|default:'' == brand.id|stringformat:"s" %}selected{% endif %}>
                                        {{ brand.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" name="is_active">
                                <option value="">Todos</option>
                                <option value="true" {% if current_is_active|default:'' == 'true' %}selected{% endif %}>Activos</option>
                                <option value="false" {% if current_is_active|default:'' == 'false' %}selected{% endif %}>Inactivos</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="btn-group w-100" role="group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                                <a href="{% url 'custom_admin:admin_products' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i>
                                </a>
                                <button type="button" class="btn btn-outline-info" onclick="toggleAdvancedFilters()">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Filtros avanzados (ocultos por defecto) -->
                    <div class="advanced-filters mt-3" style="display: none;">
                        <form method="get" class="row g-3">
                            <input type="hidden" name="search" value="{{ current_search }}">
                            <input type="hidden" name="category" value="{{ current_category }}">
                            <input type="hidden" name="brand" value="{{ current_brand }}">
                            <input type="hidden" name="is_active" value="{{ current_is_active }}">
                            
                            <div class="col-md-3">
                                <label class="form-label small">Precio Mín.</label>
                                <input type="number" class="form-control" name="price_min" 
                                       placeholder="0.00" step="0.01" min="0" value="{{ current_price_min }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Precio Máx.</label>
                                <input type="number" class="form-control" name="price_max" 
                                       placeholder="999999.99" step="0.01" min="0" value="{{ current_price_max }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Destacado</label>
                                <select class="form-control" name="is_featured">
                                    <option value="">Todos</option>
                                    <option value="true" {% if current_is_featured == 'true' %}selected{% endif %}>Destacados</option>
                                    <option value="false" {% if current_is_featured == 'false' %}selected{% endif %}>No destacados</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Ordenar</label>
                                <div class="input-group">
                                    <select class="form-control" name="sort_by">
                                        {% for value, label in sort_options %}
                                            <option value="{{ value }}" {% if current_sort_by == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <select class="form-control" name="sort_order">
                                        <option value="asc" {% if current_sort_order == 'asc' %}selected{% endif %}>↑</option>
                                        <option value="desc" {% if current_sort_order == 'desc' %}selected{% endif %}>↓</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Filtros rápidos -->
                    <div class="mt-3">
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="{% url 'custom_admin:admin_products' %}?is_active=true" 
                               class="btn btn-outline-success">Solo Activos</a>
                            <a href="{% url 'custom_admin:admin_products' %}?is_featured=true" 
                               class="btn btn-outline-warning">Destacados</a>
                            <a href="{% url 'custom_admin:admin_products' %}?sort_by=created_at&sort_order=desc" 
                               class="btn btn-outline-info">Más Recientes</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accesos rápidos -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <i class="fas fa-folder fa-2x text-success mb-2"></i>
                            <h6>Categorías</h6>
                            <p class="text-muted small">Gestiona las categorías de productos</p>
                            <div class="btn-group" role="group">
                                <a href="{% url 'custom_admin:admin_categories' %}" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-list"></i> Ver Todas
                                </a>
                                <a href="{% url 'custom_admin:admin_category_create' %}" class="btn btn-success btn-sm">
                                    <i class="fas fa-plus"></i> Nueva
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <i class="fas fa-star fa-2x text-warning mb-2"></i>
                            <h6>Marcas</h6>
                            <p class="text-muted small">Gestiona las marcas de productos</p>
                            <div class="btn-group" role="group">
                                <a href="{% url 'custom_admin:admin_brands' %}" class="btn btn-outline-warning btn-sm">
                                    <i class="fas fa-list"></i> Ver Todas
                                </a>
                                <a href="{% url 'custom_admin:admin_brand_create' %}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-plus"></i> Nueva
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-box fa-2x text-primary mb-2"></i>
                            <h6>Productos</h6>
                            <p class="text-muted small">Gestiona el catálogo de productos</p>
                            <div class="btn-group" role="group">
                                <a href="{% url 'custom_admin:admin_products' %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-list"></i> Ver Todos
                                </a>
                                <a href="{% url 'custom_admin:admin_product_create' %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus"></i> Nuevo
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicador de resultados -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Mostrando {{ products.start_index }}-{{ products.end_index }} de {{ products.paginator.count }} productos
                    </small>
                </div>
                <div class="col-md-4 text-right">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printProducts()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>

            <!-- Tabla de productos -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>Imagen</th>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Marca</th>
                                    <th>SKU</th>
                                    <th>Precio</th>
                                    <th>Stock</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr>
                                    <td>
                                        {% if product.images.first %}
                                            <img src="{{ product.images.first.image.url }}" 
                                                 alt="{{ product.name }}" 
                                                 class="img-thumbnail" 
                                                 style="width: 50px; height: 50px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center" 
                                                 style="width: 50px; height: 50px;">
                                                <i class="fas fa-image text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ product.name }}</strong>
                                        {% if product.description %}
                                            <br><small class="text-muted">{{ product.description|truncatechars:50 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ product.category.name }}</td>
                                    <td>{{ product.brand.name }}</td>
                                    <td><code>{{ product.sku }}</code></td>
                                    <td class="price-cell">${{ product.price|floatformat:0 }}</td>
                                    <td>
                                        {% if product.stock_set.exists %}
                                            {% for stock in product.stock_set.all %}
                                                <span class="badge badge-info">{{ stock.warehouse.name }}: {{ stock.quantity }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">Sin stock</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if product.is_active %}
                                            <span class="badge badge-success">Activo</span>
                                        {% else %}
                                            <span class="badge badge-secondary">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'custom_admin:admin_product_detail' product.pk %}" class="btn btn-sm btn-outline-primary" title="Ver">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'custom_admin:admin_product_edit' product.pk %}" class="btn btn-sm btn-outline-warning" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'custom_admin:admin_product_delete' product.pk %}" class="btn btn-sm btn-outline-danger" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">
                                        <i class="fas fa-box-open fa-2x mb-2"></i><br>
                                        No se encontraron productos
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    {% if products.has_other_pages %}
                    <nav aria-label="Paginación de productos">
                        <ul class="pagination justify-content-center">
                            {% if products.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if brand_id %}&brand={{ brand_id }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ products.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if brand_id %}&brand={{ brand_id }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">
                                    Página {{ products.number }} de {{ products.paginator.num_pages }}
                                </span>
                            </li>

                            {% if products.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ products.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if brand_id %}&brand={{ brand_id }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ products.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if brand_id %}&brand={{ brand_id }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para mostrar/ocultar filtros avanzados
function toggleAdvancedFilters() {
    const advancedFilters = document.querySelector('.advanced-filters');
    const button = document.querySelector('[onclick="toggleAdvancedFilters()"]');
    
    if (advancedFilters) {
        if (advancedFilters.style.display === 'none') {
            advancedFilters.style.display = 'block';
            button.innerHTML = '<i class="fas fa-cog"></i>';
            button.classList.add('active');
        } else {
            advancedFilters.style.display = 'none';
            button.innerHTML = '<i class="fas fa-cog"></i>';
            button.classList.remove('active');
        }
    }
}

// Función para mostrar filtros activos (simplificada)
function showActiveFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    const activeFilters = [];
    
    if (urlParams.get('search')) {
        activeFilters.push(`"${urlParams.get('search')}"`);
    }
    if (urlParams.get('category')) {
        const categorySelect = document.querySelector('select[name="category"]');
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        if (selectedOption.value) {
            activeFilters.push(`Categoría: ${selectedOption.text}`);
        }
    }
    if (urlParams.get('brand')) {
        const brandSelect = document.querySelector('select[name="brand"]');
        const selectedOption = brandSelect.options[brandSelect.selectedIndex];
        if (selectedOption.value) {
            activeFilters.push(`Marca: ${selectedOption.text}`);
        }
    }
    if (urlParams.get('is_active')) {
        const status = urlParams.get('is_active') === 'true' ? 'Activos' : 'Inactivos';
        activeFilters.push(`Estado: ${status}`);
    }
    
    if (activeFilters.length > 0) {
        const filterIndicator = document.createElement('div');
        filterIndicator.className = 'alert alert-info alert-sm mb-3';
        filterIndicator.innerHTML = `
            <small>
                <i class="fas fa-filter"></i> <strong>Filtros:</strong> ${activeFilters.join(' • ')}
                <a href="{% url 'custom_admin:admin_products' %}" class="float-right">
                    <i class="fas fa-times"></i> Limpiar
                </a>
            </small>
        `;
        
        const filtersCard = document.querySelector('.card.mb-4');
        filtersCard.parentNode.insertBefore(filterIndicator, filtersCard.nextSibling);
    }
}

// Función para auto-submit en cambios de ordenamiento
document.addEventListener('DOMContentLoaded', function() {
    const sortSelects = document.querySelectorAll('select[name="sort_by"], select[name="sort_order"]');
    sortSelects.forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });
    
    // Mostrar filtros activos al cargar la página
    showActiveFilters();
});

// Función para validar rangos de precio
function validatePriceRange() {
    const priceMin = document.querySelector('input[name="price_min"]');
    const priceMax = document.querySelector('input[name="price_max"]');
    
    if (priceMin.value && priceMax.value) {
        if (parseFloat(priceMin.value) > parseFloat(priceMax.value)) {
            alert('El precio mínimo no puede ser mayor al precio máximo');
            return false;
        }
    }
    return true;
}

// Agregar validación al formulario
document.querySelector('form').addEventListener('submit', function(e) {
    if (!validatePriceRange()) {
        e.preventDefault();
    }
});

// Función para imprimir productos
function printProducts() {
    window.print();
}

// Función para formatear números con puntos de miles
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Formatear precios al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    const priceCells = document.querySelectorAll('.price-cell');
    priceCells.forEach(function(cell) {
        const text = cell.textContent;
        const match = text.match(/\$(\d+)/);
        if (match) {
            const number = parseInt(match[1]);
            const formattedNumber = formatNumber(number);
            cell.textContent = text.replace(/\$\d+/, '$' + formattedNumber);
        }
    });
});
</script>
{% endblock %}